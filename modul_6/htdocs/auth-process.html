<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Processing Â· Phoning</title>

  <!-- Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css"
  />

  <!-- Font -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500&display=swap"
  />

  <!-- Material Symbols -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
  />

  <!-- Main CSS -->
  <link rel="stylesheet" href="style.css" />
</head>
<body class="login-body">

  <!-- Simple Navbar -->
  <nav class="navbar login-navbar">
    <div class="logo-container">
      <img
        class="logo-img"
        src="https://api.builder.io/api/v1/image/assets/TEMP/88ae49d6ac3aea10d5fc2fd10a544b233d5bedc1?width=72"
        alt="Phoning Logo"
      />
      <a href="index.html" class="logo-text">Phoning</a>
    </div>
    
    <a href="index.html" class="back-btn">
      <span class="material-symbols-outlined">arrow_back</span>
      Back
    </a>
  </nav>

  <!-- Processing Section -->
  <section class="login-section">
    <div class="login-card">
      {% 
from urllib.parse import unquote
import json
import re
import os

# Database file path
DB_FILE = 'modul_6/users_db.json'

def load_users():
    """Load users from JSON file"""
    default_users = {
        '722@dor.com': {
            'password': 'banheesoo',
            'nama': 'Ban Heesoo',
            'email': '722@dor.com'
        }
    }
    
    try:
        if os.path.exists(DB_FILE):
            with open(DB_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        else:
            # Create new file with default user
            save_users(default_users)
            return default_users
    except Exception as e:
        return default_users

def save_users(users_data):
    """Save users to JSON file"""
    try:
        os.makedirs(os.path.dirname(DB_FILE), exist_ok=True)
        with open(DB_FILE, 'w', encoding='utf-8') as f:
            json.dump(users_data, f, indent=2, ensure_ascii=False)
        return True
    except Exception as e:
        return False

# Load users database
users_db = load_users()

def validate_email(email):
    """Validate email format"""
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return re.match(pattern, email) is not None

def authenticate(username_or_email, password):
    """Validate login with username or email"""
    # Check directly as username
    if username_or_email in users_db:
        if users_db[username_or_email]['password'] == password:
            return True, users_db[username_or_email]
    
    # If not found, search by email
    for username, user_data in users_db.items():
        if user_data.get('email', '').lower() == username_or_email.lower():
            if user_data['password'] == password:
                return True, user_data
    
    return False, None

def register_user(username, email, password):
    if username in users_db:
        return False, "Username already taken"
    if not validate_email(email):
        return False, "Invalid email format"
    if len(password) < 3:
        return False, "Password must be at least 3 characters"

    users_db[username] = {
        'password': password,
        'nama': username.title(),
        'email': email
    }

    if save_users(users_db):
        return True, "Registration successful"
    return False, "Failed to save data"

# ==================== PROCESS REQUEST ====================
if '_POST' in dir() and _POST:
    action = unquote(_POST.get('action', ''))
    username = unquote(_POST.get('username', ''))
    password = unquote(_POST.get('password', ''))

    # ---------- LOGIN ----------
    if action == 'login':
        is_valid, user_data = authenticate(username, password)
        if is_valid:
            nama_encoded = user_data['nama'].replace(' ', '+')
            redirect_url = f'dashboard.html?user={username}&name={nama_encoded}'
            
            emit('<h1 class="login-title">Login Successful!</h1>')
            emit('<p class="login-subtitle">Welcome back, ', user_data['nama'], '!</p>')
            emit('<div style="margin-top:24px">')
            emit('<div class="login-submit" style="pointer-events:none;opacity:.85">Redirecting to dashboard...</div>')
            emit('</div>')
            emit('<meta http-equiv="refresh" content="2;url=', redirect_url, '">')
        else:
            emit('<h1 class="login-title" style="color: #f44336;">Login Failed</h1>')
            emit('<p class="login-subtitle">Username or password is incorrect</p>')
            emit('<button onclick="window.location.href=\'login.html\'" class="login-submit">Try Again</button>')
            emit('<button onclick="window.location.href=\'signup.html\'" class="login-submit" style="background:#6c757d;margin-top:10px">Sign Up</button>')

    # ---------- SIGNUP ----------
    elif action == 'signup':
        email = unquote(_POST.get('email', ''))
        success, message = register_user(username, email, password)

        if success:
            emit('<h1 class="login-title" style="color: #4CAF50;">Registration Successful!</h1>')
            emit('<p class="login-subtitle">Your account has been created</p>')
            emit('<div style="margin-top:20px;padding:20px;background:#e8f5e9;border-radius:8px;">')
            emit('<p style="margin:5px 0;"><strong>Username:</strong> ', username, '</p>')
            emit('<p style="margin:5px 0;"><strong>Email:</strong> ', email, '</p>')
            emit('</div>')
            emit('<button onclick="window.location.href=\'login.html\'" class="login-submit" style="margin-top:20px">Login Now</button>')
        else:
            emit('<h1 class="login-title" style="color: #f44336;">Registration Failed</h1>')
            emit('<p class="login-subtitle">', message, '</p>')
            emit('<button onclick="window.location.href=\'signup.html\'" class="login-submit">Try Again</button>')
            emit('<button onclick="window.location.href=\'login.html\'" class="login-submit" style="background:#6c757d;margin-top:10px">Login</button>')
            

    # ---------- INVALID ----------
    else:
        emit('<h1 class="login-title">Invalid Access</h1>')
        emit('<p class="login-subtitle">Please use the login or signup form</p>')
        emit('<button onclick="window.location.href=\'login.html\'" class="login-submit">Login</button>')
        emit('<button onclick="window.location.href=\'signup.html\'" class="login-submit" style="background:#6c757d;margin-top:10px">Sign Up</button>')

else:
    emit('<h1 class="login-title">Invalid Access</h1>')
    emit('<p class="login-subtitle">Please use the login or signup form</p>')
    emit('<button onclick="window.location.href=\'login.html\'" class="login-submit">Login</button>')
    emit('<button onclick="window.location.href=\'signup.html\'" class="login-submit" style="background:#6c757d;margin-top:10px">Sign Up</button>')
%}
    </div>
  </section>

</body>
</html>




